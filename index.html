<!DOCTYPE html>
<html>
<head>
    <title>Corner Size Measure</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Markdown for AI Text -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #1890ff;
            --accent: #ff4d4f;
            --ai-color: #8e44ad;
            --bg-dark: #121212;
            --bg-panel: #fff;
            --text-main: #333;
            --text-sub: #666;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 0; margin: 0; 
            background: var(--bg-dark); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- LAYOUT --- */
        .sidebar { 
            flex: 0 0 340px; 
            background: var(--bg-panel); 
            padding: 0; /* Padding inside content wrapper */
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); 
            display: flex; 
            flex-direction: column; 
            z-index: 20; 
        }

        .sidebar-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .main-area { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            min-width: 0; 
            position: relative; 
            background: #000;
        }

        /* --- CANVAS --- */
        .canvas-container { 
            flex: 1; 
            position: relative; 
            overflow: auto; /* Enable native scrolling/panning */
            display: grid; 
            place-items: center; 
            /* Allow browser panning, we only preventDefault on handles */
            touch-action: pan-x pan-y; 
            padding: 40px; 
        }
        
        canvas { 
            display: block; 
            background: white; 
            box-shadow: 0 0 50px rgba(255,255,255,0.1); 
            /* No margin auto here, grid handles centering */
        }

        /* --- TOOLBAR --- */
        .toolbar { 
            background: #333; 
            padding: 15px; 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            z-index: 10; 
            color: #eee;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .toolbar label { font-weight: 600; font-size: 0.9rem; white-space: nowrap; }

        input[type=range] { -webkit-appearance: none; width: 120px; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #666; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: var(--primary); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.3); }

        /* --- TYPOGRAPHY & UI --- */
        h2 { margin-top: 0; font-size: 1.2rem; color: var(--text-main); display: flex; align-items: center; }
        h3 { font-size: 0.8rem; color: var(--text-sub); margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-weight: 700; }

        .file-input-wrapper { margin-bottom: 15px; }
        input[type="file"] { width: 100%; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; }

        button { 
            width: 100%; padding: 12px; margin-bottom: 8px; 
            cursor: pointer; border: 1px solid #ddd; border-radius: 8px; background: #fff; 
            text-align: left; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; justify-content: space-between; font-size: 0.95rem;
        }
        button:hover { background: #f0f7ff; border-color: var(--primary); }
        button.active { background: #e6f7ff; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        button.completed { border-left: 4px solid #52c41a; }

        button.action-btn { 
            background: var(--primary); color: white; border: none;
            text-align: center; justify-content: center;
        }
        button.action-btn:hover { background: #40a9ff; color: white; }
        button.action-btn:active { transform: translateY(1px); }

        button.ai-btn {
            background: linear-gradient(135deg, #8e44ad 0%, #3498db 100%);
            color: white; border: none; text-align: center; justify-content: center;
            font-weight: bold; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3);
        }

        button.small-btn {
            padding: 10px; font-size: 0.85rem; width: 48%; display: inline-block; text-align: center;
            background: #f0f0f0; border: 1px solid #ccc; justify-content: center;
        }
        button.small-btn:hover { background: #e0e0e0; }

        .status-dot { height: 8px; width: 8px; background: #ddd; border-radius: 50%; display: inline-block; }
        button.active .status-dot { background: var(--primary); box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }
        button.completed .status-dot { background: #52c41a; }

        .instructions { font-size: 0.85rem; color: #666; margin-top: 15px; line-height: 1.5; background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #eee; }

        /* --- RESULTS PANEL --- */
        .results { background: #f6ffed; border: 1px solid #b7eb8f; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 14px; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 5px; color: #555; }
        .result-row.sub { margin-left: 10px; color: #777; border-bottom: 1px dashed #e0e0e0; padding-bottom: 2px; }
        .result-row.main { font-size: 1.1rem; font-weight: 700; margin-top: 12px; border-top: 1px solid #d9d9d9; padding-top: 12px; color: #333; display: flex; align-items: center; }
        
        .color-box { width: 12px; height: 12px; display: inline-block; margin-right: 10px; border-radius: 3px; vertical-align: middle; }
        .box-color { background: var(--primary); }
        .corner-color { background: var(--danger); }

        /* --- TOOLTIPS --- */
        .info-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 20px; height: 20px; background: #ccc; color: white;
            border-radius: 50%; font-size: 12px; font-weight: bold; font-family: serif;
            margin-left: 8px; cursor: help; flex-shrink: 0; transition: background 0.2s;
        }
        .info-icon:hover { background: #888; }

        #globalTooltip {
            position: fixed; background: rgba(30, 30, 30, 0.95); color: #fff; 
            padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.6; 
            max-width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            z-index: 99999; display: none; white-space: pre-wrap; 
            border: 1px solid #555; pointer-events: none;
        }

        #aiModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100000;
            display: none; align-items: center; justify-content: center;
        }
        .ai-content {
            background: white; width: 90%; max-width: 500px; max-height: 80vh;
            border-radius: 16px; padding: 25px; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); font-size: 15px; color: #333;
        }
        .ai-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--ai-color); display: flex; justify-content: space-between; }
        .close-modal { cursor: pointer; font-size: 24px; color: #999; }

        /* --- MOBILE LAYOUT (SLIDE UP) --- */
        .sheet-handle-bar { display: none; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            
            .sidebar { 
                position: fixed; bottom: 0; left: 0; right: 0;
                width: 100%; height: 85vh;
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
                transform: translateY(calc(100% - 130px)); /* Peak height */
                transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            }
            
            .sidebar.open { transform: translateY(0); }

            /* Black Pull Handle */
            .sheet-handle-bar {
                display: flex; justify-content: center; align-items: center;
                height: 30px; width: 100%; cursor: pointer; flex-shrink: 0;
                background: white; border-radius: 24px 24px 0 0;
                border-bottom: 1px solid #f0f0f0;
            }
            .pull-pill {
                width: 50px; height: 6px; background: #000; border-radius: 10px;
            }

            .main-area { 
                position: absolute; top: 0; left: 0; right: 0; bottom: 0;
                height: 100vh;
            }
            
            /* Give canvas space so it isn't hidden by the collapsed sheet */
            .canvas-container { padding-bottom: 140px; }

            .toolbar {
                position: absolute; top: 20px; right: 20px;
                background: rgba(30,30,30,0.8); border-radius: 30px;
                padding: 10px 20px; width: auto;
                border: 1px solid #555; backdrop-filter: blur(5px);
            }

            #globalTooltip {
                top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important;
                width: 80%; max-width: 340px; background: #222; pointer-events: auto;
                box-shadow: 0 0 100px rgba(0,0,0,0.9); border: 1px solid #444;
            }
            #globalTooltip::after {
                content: '(Tap anywhere to close)'; display: block; margin-top: 15px; padding-top: 10px; border-top: 1px solid #444;
                font-size: 12px; color: #888; text-align: center; font-style: italic;
            }
        }
    </style>
</head>
<body>

    <div id="globalTooltip" onclick="this.style.display='none'"></div>
    
    <!-- AI Modal -->
    <div id="aiModal">
        <div class="ai-content">
            <div class="ai-header"><span>Gemologist AI ✨</span><span class="close-modal" onclick="document.getElementById('aiModal').style.display='none'">&times;</span></div>
            <div id="aiResult">Loading...</div>
        </div>
    </div>

    <!-- MAIN IMAGE AREA -->
    <div class="main-area">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas"></canvas>
        </div>
        <div class="toolbar">
            <label>Zoom</label>
            <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1" style="width:100px">
            <span id="zoomVal" class="zoom-label">1.0x</span>
        </div>
    </div>

    <!-- SLIDE UP SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sheet-handle-bar" onclick="toggleSheet()">
            <div class="pull-pill"></div>
        </div>
        
        <div class="sidebar-scroll-area">
            <h2>Corner Size <span class="info-icon" data-tooltip="Tool Purpose:&#10;&#10;Measures 'Corner Size' of Emerald Cut diamonds.&#10;&#10;1. Outline: Blue Box.&#10;2. Corners: Red Lines.&#10;3. Grades: VEN & AG.">i</span></h2>
            
            <div class="file-input-wrapper"><input type="file" id="imageLoader" accept="image/*"></div>

            <button class="action-btn" onclick="drawDefaultShape()">Reset to Default Shape</button>

            <h3>1. Stone Outline</h3>
            <button id="btnBox" onclick="selectTool('box')"><span><span class="color-box box-color"></span>Adjust Blue Box</span><span class="status-dot"></span></button>

            <h3>2. Corner Cuts</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                 <button class="small-btn" onclick="setCornersPercentage(0.18)">Preset 18%</button>
                 <button class="small-btn" onclick="setCornersPercentage(0.35)">Preset 35%</button>
            </div>
            <button id="btnC1" onclick="selectTool(0)"><span><span class="color-box corner-color"></span>Top Left (1)</span><span class="status-dot"></span></button>
            <button id="btnC2" onclick="selectTool(1)"><span><span class="color-box corner-color"></span>Top Right (2)</span><span class="status-dot"></span></button>
            <button id="btnC3" onclick="selectTool(2)"><span><span class="color-box corner-color"></span>Bot Right (3)</span><span class="status-dot"></span></button>
            <button id="btnC4" onclick="selectTool(3)"><span><span class="color-box corner-color"></span>Bot Left (4)</span><span class="status-dot"></span></button>

            <div class="results" id="resultsPanel" style="display:none;">
                <h3>Results</h3>
                <div class="result-row"><span>Dimensions:</span> <span id="resDim" style="font-weight:bold;">--</span></div>
                <div class="result-row sub"><span>Top Left (1):</span> <span id="resC1">--</span></div>
                <div class="result-row sub"><span>Top Right (2):</span> <span id="resC2">--</span></div>
                <div class="result-row sub"><span>Bot Right (3):</span> <span id="resC3">--</span></div>
                <div class="result-row sub"><span>Bot Left (4):</span> <span id="resC4">--</span></div>
                <div class="result-row"><span>Avg Corner:</span> <span id="resAvgCorner" style="font-weight:bold;">--</span></div>
                
                <div class="result-row main"><span>VEN Method <span class="info-icon" data-tooltip="VEN: Corner / Avg(L,W)">i</span></span><span id="resInd" style="color: #d4380d;">--%</span></div>
                <div class="result-row main" style="margin-top:10px; border:none; padding:0;"><span>AG Method <span class="info-icon" data-tooltip="AG: Avg(Corner/L, Corner/W)">i</span></span><span id="resAG" style="color: #389e0d;">--%</span></div>
                
                <button class="ai-btn" style="margin-top: 15px; width:100%;" onclick="runDataAnalysis()">AI Cut Analysis ✨</button>
            </div>
        </div>
    </div>

<script>
    // --- APP STATE ---
    const apiKey = ""; 
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();
    
    let stoneQuad = null; 
    let corners = [null, null, null, null]; 
    let fitScale = 1.0; 
    let currentMultiplier = 1.0; 
    let activeTool = null; 
    let isDragging = false; 
    let dragTarget = null; 
    let dragRatios = [null, null, null, null];
    
    // Zoom Pinch
    let initialPinchDist = 0;
    let initialZoom = 1.0;

    const LINE_WIDTH = 3; const DOT_RADIUS = 8; const SNAP_DIST = 40; const IMG_PAD = 60;

    // --- MOBILE SHEET ---
    const sidebar = document.getElementById('sidebar');
    const sheetHandle = document.querySelector('.sheet-handle-bar');
    let sheetStartY = 0;
    let isSheetDragging = false;

    function toggleSheet() { sidebar.classList.toggle('open'); }
    function openSheet() { sidebar.classList.add('open'); }

    // Touch Drag for Sheet
    sheetHandle.addEventListener('touchstart', e => {
        sheetStartY = e.touches[0].clientY;
        isSheetDragging = true;
    });
    sheetHandle.addEventListener('touchmove', e => {
        if(!isSheetDragging) return;
        const delta = e.touches[0].clientY - sheetStartY;
        if(delta < -50) openSheet(); // Drag up
        if(delta > 50) sidebar.classList.remove('open'); // Drag down
    });
    sheetHandle.addEventListener('touchend', () => isSheetDragging = false);

    // --- INIT ---
    document.getElementById('imageLoader').addEventListener('change', handleImage, false);
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValDisplay = document.getElementById('zoomVal');
    zoomSlider.addEventListener('input', (e) => { currentMultiplier = parseFloat(e.target.value); applyZoom(); });
    window.addEventListener('resize', () => { if(img.src) { calcBaseScale(); applyZoom(); } });

    // --- TOOLTIPS ---
    const tooltip = document.getElementById('globalTooltip');
    const isMobile = () => window.innerWidth < 768;
    document.querySelectorAll('.info-icon').forEach(icon => {
        icon.addEventListener('click', (e) => {
            e.stopPropagation();
            tooltip.innerText = e.target.getAttribute('data-tooltip');
            tooltip.style.display = 'block';
        });
        icon.addEventListener('mouseenter', (e) => {
            if(!isMobile()) {
                tooltip.innerText = e.target.getAttribute('data-tooltip');
                tooltip.style.display = 'block';
                moveTooltip(e);
            }
        });
        icon.addEventListener('mousemove', (e) => { if(!isMobile()) moveTooltip(e); });
        icon.addEventListener('mouseleave', () => { if(!isMobile()) tooltip.style.display = 'none'; });
    });
    window.addEventListener('click', (e) => { if(!e.target.classList.contains('info-icon')) tooltip.style.display = 'none'; });
    function moveTooltip(e) {
        if(isMobile()) return;
        let x = e.clientX + 20; let y = e.clientY;
        const r = tooltip.getBoundingClientRect();
        if(y + r.height > window.innerHeight) y = window.innerHeight - r.height - 10;
        if(x + r.width > window.innerWidth) x = window.innerWidth - r.width - 10;
        tooltip.style.left = x + 'px'; tooltip.style.top = y + 'px';
    }

    // --- IMAGE LOAD ---
    function handleImage(e){
        if (!e.target.files || !e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(event){
            img.onload = function(){
                canvas.width = img.width + (IMG_PAD * 2);
                canvas.height = img.height + (IMG_PAD * 2);
                stoneQuad = null; corners = [null, null, null, null];
                currentMultiplier = 1.0; zoomSlider.value = 1.0;
                calcBaseScale(); applyZoom(); updateUI();
                drawDefaultShape(); // MANUAL MODE
                openSheet();
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    }

    function calcBaseScale() {
        const container = document.getElementById('canvasContainer');
        const availW = container.clientWidth; const availH = container.clientHeight;
        const scaleW = availW / canvas.width; const scaleH = availH / canvas.height;
        fitScale = Math.min(scaleW, scaleH);
        if(isMobile() && fitScale > 1) fitScale = 1;
    }
    function applyZoom() {
        if(!img.src) return;
        const s = fitScale * currentMultiplier;
        canvas.style.width = (canvas.width * s) + 'px'; canvas.style.height = (canvas.height * s) + 'px';
        zoomValDisplay.innerText = currentMultiplier.toFixed(1) + "x";
    }

    // --- ZOOM PINCH (MOBILE) ---
    const container = document.getElementById('canvasContainer');
    container.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            initialPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            initialZoom = currentMultiplier;
            e.preventDefault();
        } else if (e.touches.length === 1) {
             const p = getPos(e.touches[0]);
             if(checkHandles(p)) { e.preventDefault(); start(p); }
        }
    }, {passive: false});

    container.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            const delta = dist / initialPinchDist;
            let newZoom = initialZoom * delta;
            newZoom = Math.max(1, Math.min(5, newZoom));
            currentMultiplier = newZoom;
            zoomSlider.value = newZoom;
            applyZoom();
            e.preventDefault();
        } else if (e.touches.length === 1 && isDragging) {
            e.preventDefault(); move(getPos(e.touches[0]));
        }
    }, {passive: false});

    container.addEventListener('touchend', end);

    // Mouse Fallbacks
    canvas.addEventListener('mousedown', e => start(getPos(e)));
    window.addEventListener('mousemove', e => { if(isDragging) move(getPos(e)); });
    window.addEventListener('mouseup', end);


    // --- MANUAL DEFAULT ---
    function drawDefaultShape() {
        if(!img.src) return;
        ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img, IMG_PAD, IMG_PAD);
        const imgW = img.width; const imgH = img.height;
        let defH = imgH * 0.99; let defW = defH / 1.45; 
        if (defW > imgW * 0.99) { defW = imgW * 0.99; defH = defW * 1.45; }
        const cx = imgW/2 + IMG_PAD; const cy = imgH/2 + IMG_PAD;
        const halfW = defW / 2; const halfH = defH / 2;
        stoneQuad = [{x:cx-halfW, y:cy-halfH}, {x:cx+halfW, y:cy-halfH}, {x:cx+halfW, y:cy+halfH}, {x:cx-halfW, y:cy+halfH}];
        setCornersPercentage(0.18);
    }

    function setCornersPercentage(fraction) {
        if(!stoneQuad) return;
        const w = dist(stoneQuad[0].x, stoneQuad[0].y, stoneQuad[1].x, stoneQuad[1].y);
        const h = dist(stoneQuad[0].x, stoneQuad[0].y, stoneQuad[3].x, stoneQuad[3].y);
        const d = Math.min(w, h) * fraction;
        function getPt(a, b, distVal) {
            const tot = dist(a.x,a.y, b.x,b.y); if(tot===0) return a;
            const t = distVal/tot; return { x: a.x+(b.x-a.x)*t, y: a.y+(b.y-a.y)*t };
        }
        corners[0] = { x1: getPt(stoneQuad[0], stoneQuad[1], d).x, y1: getPt(stoneQuad[0], stoneQuad[1], d).y, x2: getPt(stoneQuad[0], stoneQuad[3], d).x, y2: getPt(stoneQuad[0], stoneQuad[3], d).y };
        corners[1] = { x1: getPt(stoneQuad[1], stoneQuad[0], d).x, y1: getPt(stoneQuad[1], stoneQuad[0], d).y, x2: getPt(stoneQuad[1], stoneQuad[2], d).x, y2: getPt(stoneQuad[1], stoneQuad[2], d).y };
        corners[2] = { x1: getPt(stoneQuad[2], stoneQuad[3], d).x, y1: getPt(stoneQuad[2], stoneQuad[3], d).y, x2: getPt(stoneQuad[2], stoneQuad[1], d).x, y2: getPt(stoneQuad[2], stoneQuad[1], d).y };
        corners[3] = { x1: getPt(stoneQuad[3], stoneQuad[2], d).x, y1: getPt(stoneQuad[3], stoneQuad[2], d).y, x2: getPt(stoneQuad[3], stoneQuad[0], d).x, y2: getPt(stoneQuad[3], stoneQuad[0], d).y };
        updateUI(); draw();
    }

    function getPos(e) { const r=canvas.getBoundingClientRect(); return { x:(e.clientX-r.left)*(canvas.width/r.width), y:(e.clientY-r.top)*(canvas.height/r.height) }; }
    function checkHandles(pos) {
        const r = SNAP_DIST * 1.5;
        for(let i=0; i<4; i++) {
            const c=corners[i];
            if(c) {
                if(dist(pos.x, pos.y, c.x1, c.y1)<r) return {type:'corner', idx:i, h:1};
                if(dist(pos.x, pos.y, c.x2, c.y2)<r) return {type:'corner', idx:i, h:2};
            }
        }
        if(stoneQuad) for(let i=0; i<4; i++) if(dist(pos.x, pos.y, stoneQuad[i].x, stoneQuad[i].y)<r) return {type:'quad', idx:i};
        return null;
    }
    
    function start(pos) {
        if(!img.src) return; dragTarget = checkHandles(pos);
        if(dragTarget) {
            isDragging = true;
            if(dragTarget.type === 'quad') {
                dragRatios = [{},{},{},{}];
                for(let i=0; i<4; i++) {
                    if(corners[i]) {
                        let e1=(i===0)?[0,1]:(i===1)?[0,1]:(i===2)?[3,2]:[3,2];
                        let e2=(i===0)?[0,3]:(i===1)?[1,2]:(i===2)?[1,2]:[0,3];
                        dragRatios[i].t1 = getRatio(corners[i].x1, corners[i].y1, stoneQuad[e1[0]], stoneQuad[e1[1]]);
                        dragRatios[i].t2 = getRatio(corners[i].x2, corners[i].y2, stoneQuad[e2[0]], stoneQuad[e2[1]]);
                    }
                }
            }
        }
    }
    function move(pos) {
        if(!dragTarget) return;
        if(dragTarget.type === 'quad') {
            stoneQuad[dragTarget.idx] = {x:pos.x, y:pos.y};
            for(let i=0; i<4; i++) {
                let e1=(i===0)?[0,1]:(i===1)?[0,1]:(i===2)?[3,2]:[3,2];
                let e2=(i===0)?[0,3]:(i===1)?[1,2]:(i===2)?[1,2]:[0,3];
                const p1 = getP(dragRatios[i].t1, stoneQuad[e1[0]], stoneQuad[e1[1]]);
                const p2 = getP(dragRatios[i].t2, stoneQuad[e2[0]], stoneQuad[e2[1]]);
                corners[i] = {x1:p1.x, y1:p1.y, x2:p2.x, y2:p2.y};
            }
        } else if(dragTarget.type === 'corner') {
            const c = corners[dragTarget.idx]; const snapped = snapToQuad(pos);
            if(dragTarget.h === 1) { c.x1=snapped.x; c.y1=snapped.y; } else { c.x2=snapped.x; c.y2=snapped.y; }
        }
        draw();
    }
    function end() { isDragging = false; dragTarget = null; updateUI(); }

    function getRatio(px, py, a, b) { const dx=b.x-a.x, dy=b.y-a.y; if(dx*dx+dy*dy===0) return 0; return Math.max(0, Math.min(1, ((px-a.x)*dx+(py-a.y)*dy)/(dx*dx+dy*dy))); }
    function getP(t, a, b) { return { x: a.x + t*(b.x-a.x), y: a.y + t*(b.y-a.y) }; }
    function snapToQuad(p) {
        if(!stoneQuad) return p; let bestPt=p, minD=Infinity;
        for(let i=0; i<4; i++) {
            const a=stoneQuad[i], b=stoneQuad[(i+1)%4];
            const t = Math.max(0, Math.min(1, getRatio(p.x,p.y,a,b)));
            const cand = getP(t, a, b); const d = dist(p.x, p.y, cand.x, cand.y);
            if(d<minD) { minD=d; bestPt=cand; }
        }
        return bestPt;
    }
    
    function selectTool(tool) { activeTool = tool; updateUI(); }
    function updateUI() {
        ['btnBox','btnC1','btnC2','btnC3','btnC4'].forEach(id => document.getElementById(id).classList.remove('active'));
        if(activeTool==='box') document.getElementById('btnBox').classList.add('active');
        else if(activeTool!==null) document.getElementById('btnC'+(activeTool+1)).classList.add('active');
        if(stoneQuad) {
            document.getElementById('resultsPanel').style.display='block';
            calcResults();
        }
    }
    
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height); if(img.src) ctx.drawImage(img, IMG_PAD, IMG_PAD);
        if(stoneQuad) {
            ctx.strokeStyle = '#1890ff'; ctx.lineWidth = LINE_WIDTH;
            ctx.beginPath(); ctx.moveTo(stoneQuad[0].x, stoneQuad[0].y);
            for(let i=1; i<4; i++) ctx.lineTo(stoneQuad[i].x, stoneQuad[i].y);
            ctx.closePath(); ctx.stroke();
            ctx.fillStyle = '#1890ff';
            stoneQuad.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, DOT_RADIUS, 0, 2*Math.PI); ctx.fill(); });
        }
        corners.forEach((c,i) => {
            if(c) {
                ctx.strokeStyle = '#ff4d4f'; ctx.lineWidth = LINE_WIDTH;
                ctx.beginPath(); ctx.moveTo(c.x1, c.y1); ctx.lineTo(c.x2, c.y2); ctx.stroke();
                drawArrow(c.x1, c.y1, (stoneQuad[0].x+stoneQuad[2].x)/2, (stoneQuad[0].y+stoneQuad[2].y)/2); 
                drawArrow(c.x2, c.y2, (stoneQuad[0].x+stoneQuad[2].x)/2, (stoneQuad[0].y+stoneQuad[2].y)/2);
                ctx.fillStyle='#ff4d4f'; ctx.font='bold 16px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                const mx = (c.x1+c.x2)/2; const my = (c.y1+c.y2)/2;
                ctx.lineWidth = 3; ctx.strokeStyle = 'white'; ctx.strokeText(i+1, mx, my);
                ctx.lineWidth = 1; ctx.fillText(i+1, mx, my);
            }
        });
    }
    
    function drawArrow(x, y, cx, cy) {
        const size = 10; let dx = cx - x; let dy = cy - y;
        let len = Math.sqrt(dx*dx + dy*dy); if(len===0) {dx=1; dy=0; len=1;}
        const udx = dx/len; const udy = dy/len;
        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.moveTo(x, y); 
        const angle = Math.atan2(udy, udx);
        ctx.lineTo(x - size*Math.cos(angle-Math.PI/7), y - size*Math.sin(angle-Math.PI/7));
        ctx.lineTo(x - size*Math.cos(angle+Math.PI/7), y - size*Math.sin(angle+Math.PI/7));
        ctx.closePath(); ctx.fill();
    }

    function calcResults() {
        if(!stoneQuad) return;
        const w1 = dist(stoneQuad[0].x, stoneQuad[0].y, stoneQuad[1].x, stoneQuad[1].y);
        const w2 = dist(stoneQuad[3].x, stoneQuad[3].y, stoneQuad[2].x, stoneQuad[2].y);
        const W = (w1+w2)/2;
        const h1 = dist(stoneQuad[0].x, stoneQuad[0].y, stoneQuad[3].x, stoneQuad[3].y);
        const h2 = dist(stoneQuad[1].x, stoneQuad[1].y, stoneQuad[2].x, stoneQuad[2].y);
        const H = (h1+h2)/2;
        const L_stone = Math.max(W, H); const W_stone = Math.min(W, H);
        
        let sumC = 0; let n = 0;
        corners.forEach((c,i) => {
            let s = "--"; if(c) { const len = dist(c.x1, c.y1, c.x2, c.y2); sumC += len; n++; s = len.toFixed(1) + " px"; }
            document.getElementById('resC'+(i+1)).innerText = s;
        });

        if(n > 0) {
            const avgC = sumC / n;
            document.getElementById('resDim').innerText = Math.round(L_stone) + " x " + Math.round(W_stone);
            document.getElementById('resAvgCorner').innerText = avgC.toFixed(1) + " px";
            const ven = (avgC / ((L_stone+W_stone)/2)) * 100;
            const ag = ((avgC/L_stone)*100 + (avgC/W_stone)*100) / 2;
            document.getElementById('resInd').innerText = ven.toFixed(2) + "%";
            document.getElementById('resAG').innerText = ag.toFixed(2) + "%";
        }
    }
    
    function dist(x1, y1, x2, y2) { return Math.hypot(x1-x2, y1-y2); }

    // --- AI ---
    async function runDataAnalysis() {
        if(!apiKey) { showAIModal("Please set 'const apiKey' in the code."); return; }
        const data = { dim: document.getElementById('resDim').innerText, avg: document.getElementById('resAvgCorner').innerText, ven: document.getElementById('resInd').innerText, ag: document.getElementById('resAG').innerText };
        showAIModal("Gemini Analysis...");
        try { const res = await callGemini(`Analyze these Emerald Cut diamond specs: ${JSON.stringify(data)}. Are the corners classic or truncated?`); document.getElementById('aiResult').innerHTML = marked.parse(res); } catch(e) { document.getElementById('aiResult').innerText = "Error: " + e; }
    }
    function showAIModal(msg) { document.getElementById('aiModal').style.display = 'flex'; document.getElementById('aiResult').innerHTML = `<em>${msg}</em>`; }
    async function callGemini(text, b64=null) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const body = { contents: [{ parts: [{ text: text }] }] };
        const resp = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        const json = await resp.json();
        return json.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
    }
</script>
</body>
</html>


